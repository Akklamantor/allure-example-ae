name: API HMB ALLURE

on:
  workflow_dispatch:
    inputs:
      ALLURE_USERNAME:
        description: ALLURE_USERNAME service parameter. Leave blank.
      QA_ENV:
        type: choice
        description: 'QA Environment'
        required: false
        options:
          - sdet1
          - sdet2
          - 1
          - 2
          - 3
          - 4
          - 5
          - 6
          - 7
          - 8
          - 9
          - 10
          - 11
          - 12
          - 13
          - 14
          - 15
          - 16
          - 17
        default: 'sdet1'


env:
    ALLURE_TOKEN: ${{ secrets.ALLURE_TOKEN }}
    ALLURE_ENDPOINT: https://testing.testops.cloud/ 
    ALLURE_PROJECT_ID: 7806
    
jobs:
  build:
    timeout-minutes: 30
    runs-on:
      group: soundboard
  #  env:
    #  GPG_SECRET_KEY: ${{ secrets.GPG_SECRET_KEY }}


    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/pgp-download
        with:
          token: ${{ secrets.GH_PAT }}
      - uses: ./.github/actions/pgp-inject
        with:
          gpgFile: ${{ inputs.QA_ENV }}
      - uses: ./.github/actions/dependencies
      - name: Install API dependencies
        run: cd test-components/api && npm ci
      - name: Install PW 
        run: cd test-components/api && npx playwright install
      - name: Run API PW HMB Tests
        if: success() || failure()
        run: cd test-components/api-pw/workflow-pod && npx playwright test tests/HMB --workers=1
      - name: Upload Report Artifact
        if: success() || failure()
        uses: actions/upload-artifact@v3
        with:
          name: html-report
          path: _OUTPUT/html-report
          retention-days: 5
      - name: Upload Allure Results
        if: success() || failure()
        uses: ./.github/actions/allure
      - name: List results
        run: ls -la ${ALLURE_RESULTS}
